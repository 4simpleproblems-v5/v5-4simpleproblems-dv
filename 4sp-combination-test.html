<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - GAMES CLIENT</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/npm/4sp-dv@latest/images/logo.png">

    <base href="https://cdn.jsdelivr.net/npm/4sp-dv@1.1.6/logged-in/">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.x/dist/index.umd.js"></script>
    <!-- Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/4sp-dv@latest/analytics.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1D4F692C1Q');
    </script>

    <style>
    /* Merged Styles from 4simpleproblems_v5.html */
    body { 
        background-color: #040404; 
        color: #c0c0c0; 
        font-family: 'Geist', sans-serif; 
        height: 100vh; 
        margin: 0; 
        display: flex; 
        flex-direction: column; 
        font-weight: 300;
        overflow: hidden; /* Prevent body scroll, main content scrolls */
    }
    
    h1, h2, h3, .font-bold, .font-semibold, strong, b, .tracking-widest {
        font-weight: 400 !important;
    }

    /* Navbar Styles */
    #navbar-container {
        background: var(--navbar-bg, #000000);
        border-bottom: 1px solid var(--navbar-border, #1f2937);
        height: 64px;
        width: 100%;
        display: none; /* Hidden until unlocked */
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        box-sizing: border-box;
        flex-shrink: 0;
        z-index: 60; 
        position: relative; 
    }

    #fireworks-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0; transition: opacity 0.5s ease; }
    #navbar-container > *:not(#fireworks-container) { position: relative; z-index: 10; }
    .navbar-logo { height: 40px; width: auto; transition: filter 0.3s ease; }
    
    .tab-wrapper { flex-grow: 1; display: flex; align-items: center; position: relative; min-width: 0; margin: 0 1rem; justify-content: center; overflow: hidden; }
    .tab-scroll-container { display: flex; align-items: center; gap: 0.5rem; overflow-x: auto; scrollbar-width: none; white-space: nowrap; max-width: 100%; scroll-behavior: smooth; padding-left: 20px; padding-right: 20px; }
    .tab-scroll-container::-webkit-scrollbar { display: none; }
    .scroll-glide-button { position: absolute; top: 0; height: 100%; width: 60px; display: flex; align-items: center; justify-content: center; color: var(--glide-btn-color, #ffffff); font-size: 1rem; cursor: pointer; opacity: 1; transition: opacity 0.3s; z-index: 55; background: transparent; border: none; }
    #glide-left { left: 0; background-color: var(--navbar-bg, #000000); -webkit-mask-image: linear-gradient(to right, black 30%, transparent); mask-image: linear-gradient(to right, black 30%, transparent); justify-content: flex-start; padding-left: 8px; }
    #glide-right { right: 0; background-color: var(--navbar-bg, #000000); -webkit-mask-image: linear-gradient(to left, black 30%, transparent); mask-image: linear-gradient(to left, black 30%, transparent); justify-content: flex-end; padding-right: 8px; }
    .scroll-glide-button.hidden { opacity: 0 !important; pointer-events: none !important; }

    .nav-tab { padding: 0.5rem 1rem; color: var(--tab-text, #9ca3af); font-size: 0.875rem; font-weight: 400; border-radius: 12px; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; border: 1px solid transparent; transition: all 0.2s; cursor: pointer; flex-shrink: 0; }
    .nav-tab:hover { color: var(--tab-hover-text, #ffffff); background-color: var(--tab-hover-bg, rgba(79, 70, 229, 0.05)); border-color: var(--tab-active-border, #4f46e5); transform: translateY(-1px); z-index: 50; }
    .nav-tab.active { color: var(--tab-active-text, #4f46e5); border-color: var(--tab-active-border, #4f46e5); background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1)); }

    .auth-controls-wrapper { display: flex; align-items: center; gap: 1rem; position: relative; }
    .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #4b5563; display: flex; align-items: center; justify-content: center; color: #d1d5db; cursor: pointer; background: transparent; transition: background 0.2s; position: relative; }
    .icon-btn:hover { background-color: #374151; color: white; z-index: 50; }
    #auth-btn, #auth-btn:hover, #auth-btn:active { transform: none !important; transition: none !important; background-color: transparent !important; z-index: 65 !important; cursor: pointer !important; padding: 0; overflow: hidden; border: 1px solid #4b5563; }

    .auth-menu { position: absolute; right: 0; top: 55px; width: 16rem; background: var(--menu-bg, #000); border: 1px solid var(--menu-border, #333); border-radius: 1.5rem; padding: 0.75rem; display: none; flex-direction: column; gap: 0.5rem; z-index: 70; box-shadow: 0 10px 30px rgba(0,0,0,0.6); transform-origin: top right; }
    .auth-menu.open { display: flex; animation: menu-pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes menu-pop-in { 0% { opacity: 0; transform: translateY(-10px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
    .auth-menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--menu-item-text, #d1d5db); background: var(--menu-item-bg, #0a0a0a); border: 1px solid var(--menu-item-border, #333); border-radius: 1rem; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: all 0.3s; cursor: pointer; }
    .auth-menu-item:hover { background-color: var(--menu-item-hover-bg, #000); border-color: var(--menu-item-hover-border, #fff); color: var(--menu-item-hover-text, #fff); transform: translateY(-2px) scale(1.02); }
    .auth-header { padding: 0.5rem 1rem; border-bottom: 1px solid var(--menu-divider, #333); margin-bottom: 0.25rem; }
    .auth-username { color: var(--menu-username-text, white); font-weight: 400; font-size: 0.9rem; }
    .auth-email { color: var(--menu-email-text, #9ca3af); font-size: 0.75rem; }

    /* Merged Styles from games.html */
    .games-main-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        padding-bottom: 100px;
        background-color: #040404;
        position: relative;
        display: none; /* Hidden until loaded/authenticated */
    }

    .btn-toolbar-style { background: #000; border: 1px solid #333; border-radius: 14px; color: #d1d5db; padding: 0.5rem 1rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
    .btn-card-action { display: inline-flex; align-items: center; justify-content: center; width: 2.25rem; height: 2.25rem; border-radius: 14px; background: transparent; border: 1px solid transparent; color: #9ca3af; cursor: pointer; transition: all 0.2s; font-size: 1rem; }
    .btn-card-action:hover { background-color: rgba(79, 70, 229, 0.1); color: #4f46e5; border-color: #4f46e5; transform: scale(1.1); }
    
    .zone-item { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .zone-item:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(79, 70, 229, 0.2); }
    .other-zone-item { min-height: 250px; position: relative; z-index: 1; }
    .other-zone-item:hover { box-shadow: 0 8px 25px rgba(170, 170, 170, 0.2); z-index: 10; }
    .other-zone-item .image-overlay { background: linear-gradient(90deg, rgba(7,7,7,0.85) 0%, rgba(7,7,7,0) 40%, rgba(7,7,7,0) 60%, rgba(7,7,7,0.85) 100%); border-radius: 1.25rem; }
    
    #bottom-fixed-bar { transition: transform 0.4s, opacity 0.3s; }
    #bottom-fixed-bar:focus-within { transform: translateY(-5px); border-color: #4f46e5; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
    .search-results-container { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #333 transparent; }
    .search-item { display: flex; cursor: pointer; color: #e5e7eb; padding: 10px 15px; }
    .search-item:hover { background-color: rgba(255, 255, 255, 0.05); padding-left: 20px; }
    .category-badge { font-size: 0.6rem; padding: 1px 6px; border-radius: 6px; border: 1px solid currentColor; display: inline-block; }

    #zoneViewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 5000; flex-direction: column; opacity: 0; }
    #zoneViewer.active { display: flex; opacity: 1; }
    #zoneViewer .zone-header { background-color: #0a0a0a; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1a1a1a; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    #zoneViewer .zone-header .zone-title h2 { margin: 0; font-size: 1.2rem; color: #fff; font-weight: 500; }
    #zoneViewer .zone-header .zone-controls { display: flex; gap: 8px; }
    #zoneViewer iframe { flex-grow: 1; border: none; background-color: #000; }

    .eagler-dropdown { position: absolute; bottom: 120%; right: 0; background-color: rgba(20, 20, 20, 0.98); border: 1px solid rgba(255,255,255,0.15); border-radius: 0.75rem; padding: 0.5rem; z-index: 1000; min-width: 200px; display: none; }
    .eagler-dropdown.show { display: block; }
    .eagler-dropdown-link { display: block; padding: 0.6rem 0.8rem; color: #d1d5db; border-radius: 0.5rem; text-decoration: none; }
    .eagler-dropdown-link:hover { background-color: rgba(255,255,255,0.1); color: white; }

    #creditsModal { display: none; position: fixed; top: 0; left: 0; w: 100%; h: 100%; bg: black/70; backdrop-filter: blur(10px); z-index: 6000; justify-content: center; align-items: center; }
    #instruction-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 8000; display: none; align-items: center; justify-content: center; }
    
    /* Lock Screen */
    #lock-screen { position: fixed; inset: 0; background: #040404; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- LOCK SCREEN -->
    <div id="lock-screen">
        <div class="max-w-5xl w-full bg-[#040404] flex flex-col md:flex-row border border-[#252525] rounded-3xl overflow-hidden shadow-2xl p-4">
            <div class="flex-1 p-8 flex flex-col justify-center items-center border-b md:border-b-0 md:border-r border-[#252525]">
                <h2 class="text-3xl text-[#c0c0c0] mb-6 text-center w-full font-light tracking-tighter">4SP Version 5 Client (DV)</h2>
                <p class="text-[#505050] text-center mb-8 text-sm">Enter your 12-character access code.</p>
                <input type="text" id="codeInput" class="w-full max-w-xs bg-[#111] border border-[#252525] text-white rounded-xl p-3 text-center tracking-[0.2em] mb-4 outline-none focus:border-indigo-500 transition" placeholder="XXXX-XXXX-XXXX">
                <button id="unlockBtn" class="w-full max-w-xs py-2 px-4 text-sm font-medium rounded-xl text-indigo-500 bg-indigo-500/10 border border-indigo-500 hover:bg-indigo-500/20 transition mb-4">Access</button>
                <p id="lockMessage" class="text-red-400 text-xs mt-2 min-h-[20px] text-center"></p>
                <p id="loading-text" class="text-gray-500 text-xs mt-2 hidden text-center">Verifying...</p>
            </div>
            <div class="flex-1 p-8 flex flex-col justify-center items-center bg-[#040404]">
                <h2 class="text-3xl text-[#c0c0c0] mb-6 text-center w-full font-light tracking-tighter">How it works</h2>
                <p class="text-lg text-[#505050] mb-8 text-center max-w-md font-light leading-relaxed">This client provides secure, local access to the 4SP suite. Generate a unique code from your web dashboard to log in properly.</p>
                <a href="https://4sp-organization.github.io/connection.html" target="_blank" class="w-full max-w-xs py-2 px-4 text-sm font-medium rounded-xl text-cyan-500 bg-cyan-500/10 border border-cyan-500 hover:bg-cyan-500/20 transition text-center flex items-center justify-center">Get Your Code</a>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <div id="navbar-container">
        <div id="fireworks-container"></div>
        <img src="https://cdn.jsdelivr.net/npm/4sp-asset-library@latest/logo.png" id="navbar-logo" class="navbar-logo" alt="Logo">
        <div class="tab-wrapper">
             <button id="glide-left" class="scroll-glide-button hidden"><i class="fa-solid fa-chevron-left"></i></button>
             <div class="tab-scroll-container" id="tabs-container">
                 <!-- Tabs injected here -->
             </div>
             <button id="glide-right" class="scroll-glide-button hidden"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div class="auth-controls-wrapper">
            <div class="relative">
                <button id="auth-btn" class="icon-btn"><i class="fa-solid fa-user"></i></button>
                <div id="auth-menu" class="auth-menu">
                    <div class="auth-header"><div class="auth-username" id="display-username">Client User</div><div class="auth-email" id="display-email">local@client</div></div>
                    <div class="auth-menu-item text-red-400 hover:text-red-300" id="logout-btn"><i class="fa-solid fa-right-from-bracket w-4"></i> Disconnect</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GAMES CONTENT (Originally games.html body) -->
    <div id="games-main-container" class="games-main-container">
        <main class="mx-auto my-5 w-full max-w-screen-2xl px-4 relative">
            <button id="creditsBtn" class="absolute top-0 right-4 z-20 btn-toolbar-style">
                <i class="fa-solid fa-users mr-2"></i>Credits
            </button>
            
            <div class="mx-auto my-8 p-4 sm:p-6 w-full max-w-3xl relative">
                <p class="bg-card-dark text-white p-5 rounded-xl shadow-lg border border-brand-border text-sm sm:text-base text-center">
                    <strong>Welcome to 4SP Games!</strong><br>
                    This is a collection of games curated for the 4SP community. Use the search bar below to find your favorite.
                </p>
            </div>
            
            <div id="favoritesSection">
                <h2 id="favoritesHeader" class="text-center text-3xl font-bold mt-12 mb-6 text-white" style="display: none;">
                    <strong>Favorites</strong>
                </h2>
                <div class="games-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-4" id="favoritesGameList" style="display: none;"></div>
            </div>

            <div id="category-viewer" class="w-full mt-12">
                <div id="category-slider-container" class="relative flex items-center justify-center max-w-sm mx-auto h-12">
                    <button id="prev-category" class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl text-gray-500 hover:text-white transition-all p-2 z-10 disabled:opacity-30 disabled:text-gray-700 disabled:hover:text-gray-700">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="overflow-hidden w-64 text-center">
                        <div id="category-slider" class="flex transition-transform duration-500 ease-in-out">
                        </div>
                </div>
                <button id="next-category" class="absolute right-0 top-1/2 -translate-y-1/2 text-2xl text-gray-500 hover:text-white transition-all p-2 z-10 disabled:opacity-30 disabled:text-gray-700 disabled:hover:text-gray-700">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div id="games-grid-container" class="games-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-4 mt-6 transition-opacity duration-300 ease-in-out">
                </div>
        </div>
    </main>

    <div id="bottom-fixed-bar" class="fixed bottom-4 right-4 bg-black/80 backdrop-blur-xl rounded-3xl border border-brand-border shadow-2xl shadow-black/50 w-full max-w-md z-50 transition-all duration-300 flex flex-col">
        <div id="searchResults" class="search-results-container w-full" style="display: none;"></div>
        <div id="searchDivider" class="w-full h-[1px] bg-white/10" style="display: none;"></div>
        <div class="flex items-center w-full p-1">
            <div class="pl-4 pr-2 text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></div>
            <input type="text" id="searchInput" placeholder="Search for gamesâ€¦" autocomplete="off" class="w-full py-3 pr-4 bg-transparent text-white placeholder-gray-500 focus:outline-none focus:ring-0 text-base" />
        </div>
    </div>
    
    <div id="zoneViewer" aria-modal="true" role="dialog">
        <div class="zone-header">
             <div class="zone-title"><h2 id="zoneNameEl">Game Title</h2></div>
             <div class="zone-controls">
                <button id="fullscreenBtnZone" title="Fullscreen"><i class="fas fa-expand"></i></button>
                <a id="downloadBtnZone" title="Download" class="hidden" href="#"><i class="fas fa-download"></i></a>
                <button id="closeBtnZone" title="Close"><i class="fas fa-times"></i></button>
             </div>
        </div>
        <iframe id="zoneFrame" title="Game Content" allowfullscreen sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock"></iframe>
    </div>

    <div id="creditsModal" class="fixed top-0 left-0 w-full h-full bg-black/70 backdrop-blur-lg z-[6000] items-center justify-center p-4" style="display: none;">
        <div class="bg-card-dark rounded-xl border border-brand-border shadow-2xl w-full max-w-lg overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-brand-border sticky top-0 bg-card-dark z-10">
                <h3 class="text-xl font-bold">Project Credits</h3>
                <button id="closeCreditsBtn" class="text-white hover:text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="creditsContent" class="p-6 space-y-6"></div>
        </div>
    </div>

    <div id="instruction-overlay" class="fixed inset-0 bg-black/80 z-[8000] transition-opacity duration-300 opacity-0 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-card-dark text-white rounded-3xl border border-gray-700 shadow-2xl backdrop-blur-md w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 sm:p-8 overflow-y-auto custom-scrollbar">
                <h3 class="text-2xl font-bold mb-4 text-center">Welcome to 4SP Games</h3>
                <p class="text-sm text-gray-400 mb-6 text-center">Please read the following information before playing.</p>
                <!-- Instructions Content (Shortened for brevity in this merge) -->
                <ul class="space-y-4 text-gray-300 text-sm sm:text-base leading-relaxed">
                    <li>Use arrows to switch categories.</li>
                    <li>Some games may be unstable.</li>
                    <li>GN-Math games use a CDN.</li>
                </ul>
            </div>
            <div class="p-6 border-t border-gray-800 bg-black/20 rounded-b-3xl flex flex-col sm:flex-row items-center justify-between gap-4">
                <span class="text-xs text-gray-500">Type "I understand" to continue.</span>
                <input type="text" id="instruction-input" placeholder="Type 'I understand'" class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-normal rounded-xl text-white bg-purple-500/10 ring-1 ring-purple-500/50 focus:ring-purple-500/80 focus:bg-purple-500/20 focus:outline-none placeholder-gray-400 transition-all duration-200">
            </div>
        </div>
    </div>
    </div>

    <!-- MAIN SCRIPT (Merged Logic) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAZBKAckVa4IMvJGjcyndZx6Y1XD52lgro",
            authDomain: "project-zirconium.firebaseapp.com",
            projectId: "project-zirconium",
            storageBucket: "project-zirconium.firebasestorage.app",
            messagingSenderId: "1096564243475",
            appId: "1:1096564243475:web:6d0956a70125eeea1ad3e6",
            measurementId: "G-1D4F692C1Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CONSTANTS ---
        const STORAGE_KEY = 'local_access_code';
        const USER_DATA_KEY = 'local_user_data';
        const BASE_URL = 'https://cdn.jsdelivr.net/npm/4sp-dv@1.1.6/logged-in/';
        const OWNER_EMAIL = "4simpleproblems@gmail.com";
        
        // Games Config
        const GN_ZONES_URL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
        const GN_COVER_URL_BASE = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
        const GN_HTML_URL_BASE = "https://raw.githack.com/gn-math/html/main";
        const WORKER_ROOT = "https://dv-service-lfs.4simpleproblems.workers.dev/";
        const GAMES_BASE_URL = "https://dv-service-lfs.4simpleproblems.workers.dev/GAMES/";
        const CARDS_DATA_URL = "https://dv-service-lfs.4simpleproblems.workers.dev/GAMES/cards-data.js";
        const FAVORITES_KEY = 'gameHubFavorites_v3';
        const INSTRUCTION_KEY = '4sp-games-instruction-extended-seen';

        // --- STATE ---
        let currentUser = null;
        let userDataUnsubscribe = null;
        
        // Games State
        let allGames = [];
        let searchableGames = [];
        let categories = [];
        let currentCategoryIndex = 0;
        
        // --- DOM ELEMENTS (Shell) ---
        const lockScreen = document.getElementById('lock-screen');
        const navbar = document.getElementById('navbar-container');
        const gamesMainContainer = document.getElementById('games-main-container');
        const codeInput = document.getElementById('codeInput');
        const unlockBtn = document.getElementById('unlockBtn');
        const lockMessage = document.getElementById('lockMessage');
        const loadingText = document.getElementById('loading-text');
        const authBtn = document.getElementById('auth-btn');
        const authMenu = document.getElementById('auth-menu');
        const displayUsername = document.getElementById('display-username');
        const displayEmail = document.getElementById('display-email');
        const logoutBtn = document.getElementById('logout-btn');
        const tabsContainer = document.getElementById('tabs-container');

        // --- DOM ELEMENTS (Games) ---
        const favoritesHeader = document.getElementById("favoritesHeader");
        const favoritesGameList = document.getElementById("favoritesGameList");
        const searchInput = document.getElementById("searchInput");
        const searchResults = document.getElementById("searchResults");
        const searchDivider = document.getElementById("searchDivider");
        const categorySlider = document.getElementById('category-slider');
        const prevCategoryBtn = document.getElementById('prev-category');
        const nextCategoryBtn = document.getElementById('next-category');
        const gamesGridContainer = document.getElementById('games-grid-container');
        const creditsModal = document.getElementById('creditsModal');
        const creditsContent = document.getElementById('creditsContent');
        const creditsBtn = document.getElementById('creditsBtn');
        const closeCreditsBtn = document.getElementById('closeCreditsBtn');
        const instructionOverlay = document.getElementById('instruction-overlay');
        const instructionInput = document.getElementById('instruction-input');
        const zoneViewer = document.getElementById('zoneViewer');
        const zoneFrame = document.getElementById('zoneFrame');
        const zoneNameEl = document.getElementById('zoneNameEl');
        const downloadBtnZone = document.getElementById('downloadBtnZone');

        // --- SHELL LOGIC ---

        const CLIENT_PAGE_DATA = {
            "games": { "name": "GAMES", "icon": "fa-solid fa-gamepad", "isLocal": true }, // Special flag for embedded
            "dashboard": { "name": "Dashboard", "icon": "fa-solid fa-house-user", "url": "dashboard.html" },
            "velium": { "name": "Velium", "icon": "fa-solid fa-music", "url": "velium.html" },
            // ... add others as needed, they will open in new tabs or we could iframe them if we kept the iframe.
            // For this test, we focus on Games working natively.
        };

        // Render Navbar
        function renderNavbar() {
            tabsContainer.innerHTML = '';
            Object.entries(CLIENT_PAGE_DATA).forEach(([key, page]) => {
                const tab = document.createElement('a');
                tab.className = `nav-tab ${key === 'games' ? 'active' : ''}`; // Default active for this test
                tab.innerHTML = `<i class="${page.icon}"></i> ${page.name}`;
                tab.onclick = () => {
                    if (page.isLocal) {
                        // Switch to local view (already visible in this file)
                        console.log("Already on Games");
                    } else {
                        // Open external link
                        window.open(BASE_URL + page.url, '_blank');
                    }
                };
                tabsContainer.appendChild(tab);
            });
        }

        // Auth Logic
        async function fetchUserData(ownerUid) {
            if (userDataUnsubscribe) userDataUnsubscribe();
            try {
                 userDataUnsubscribe = onSnapshot(doc(db, "users", ownerUid), (docSnap) => {
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         const newUserData = {
                             ...currentUser,
                             uid: ownerUid,
                             username: data.username || "User",
                             email: data.email || "No email",
                             pfpType: data.pfpType,
                             customPfp: data.customPfp,
                             pfpLetterBg: data.pfpLetterBg,
                             letterAvatarText: data.letterAvatarText, 
                             navbarTheme: data.navbarTheme 
                         };
                         localStorage.setItem(USER_DATA_KEY, JSON.stringify(newUserData));
                         updateUIWithUser(newUserData);
                         currentUser = newUserData;
                         applyTheme(data.navbarTheme);
                     }
                 });
            } catch (e) { console.error("User fetch error", e); }
        }

        function updateUIWithUser(userData) {
            if (!userData) return;
            displayUsername.textContent = userData.username;
            displayEmail.textContent = userData.email;
            
            // PFP
            const pfpType = userData.pfpType || 'letter';
            let pfpHtml = '';
            if (pfpType === 'custom' && userData.customPfp) {
                pfpHtml = `<img src="${userData.customPfp}" class="w-full h-full object-cover rounded-[14px]" alt="Profile">`;
            } else {
                const initial = (userData.username || 'U').charAt(0).toUpperCase();
                const letter = userData.letterAvatarText || initial;
                const bgColor = userData.pfpLetterBg || '#3B82F6';
                pfpHtml = `<div class="w-full h-full rounded-[14px] flex items-center justify-center text-white font-bold text-lg" style="background-color: ${bgColor};">${letter}</div>`;
            }
            authBtn.innerHTML = pfpHtml;
        }

        function applyTheme(theme) {
            if (!theme) return;
            const root = document.documentElement;
            // Basic theme application
            if (theme['navbar-bg']) root.style.setProperty('--navbar-bg', theme['navbar-bg']);
            if (theme['navbar-border']) root.style.setProperty('--navbar-border', theme['navbar-border']);
            // ... add more as needed
        }

        // Lock Screen Logic
        async function checkAutoLogin() {
            const savedCode = localStorage.getItem(STORAGE_KEY);
            if (savedCode) {
                loadingText.classList.remove('hidden');
                unlockBtn.classList.add('hidden');
                codeInput.classList.add('hidden');
                
                try {
                    const docRef = doc(db, "access_codes", savedCode);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists() && docSnap.data().active) {
                        const codeData = docSnap.data();
                        if (codeData.ownerUid) await fetchUserData(codeData.ownerUid);
                        launchApp();
                        return;
                    } else {
                        localStorage.removeItem(STORAGE_KEY);
                        resetLockScreen("Session expired.");
                    }
                } catch(e) {
                    console.error("Login error", e);
                    resetLockScreen("Connection failed.");
                }
            }
        }

        function resetLockScreen(msg) {
            loadingText.classList.add('hidden');
            unlockBtn.classList.remove('hidden');
            codeInput.classList.remove('hidden');
            lockMessage.innerText = msg || "";
        }

        function launchApp() {
            lockScreen.classList.add('hidden');
            navbar.style.display = 'flex';
            gamesMainContainer.style.display = 'block'; // Show games content
            renderNavbar();
            initGamesLogic(); // Start Games Logic
        }

        unlockBtn.addEventListener('click', async () => {
            let code = codeInput.value.trim().toUpperCase().replace(/-/g, '');
            if (code.length !== 12) { lockMessage.innerText = "Invalid format."; return; }
            
            lockMessage.innerText = "";
            unlockBtn.disabled = true;
            unlockBtn.innerText = "Checking...";

            try {
                const docRef = doc(db, "access_codes", code);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists() || !docSnap.data().active) throw new Error("Invalid code.");
                
                const data = docSnap.data();
                if (data.claimed && localStorage.getItem(STORAGE_KEY) !== code) throw new Error("Code used.");

                await updateDoc(docRef, { claimed: true });
                localStorage.setItem(STORAGE_KEY, code);
                if (data.ownerUid) await fetchUserData(data.ownerUid);
                launchApp();
            } catch (e) {
                lockMessage.innerText = e.message;
                unlockBtn.disabled = false;
                unlockBtn.innerText = "Login";
            }
        });

        if (authBtn) authBtn.addEventListener('click', (e) => { e.stopPropagation(); authMenu.classList.toggle('open'); });
        document.addEventListener('click', (e) => { if (!authMenu.contains(e.target) && !authBtn.contains(e.target)) authMenu.classList.remove('open'); });
        if (logoutBtn) logoutBtn.addEventListener('click', () => { localStorage.removeItem(STORAGE_KEY); location.reload(); });

        // --- GAMES LOGIC (Merged) ---
        
        async function fetchGameData() {
            try {
                const response = await fetch(CARDS_DATA_URL);
                if (!response.ok) throw new Error('Failed to fetch game data');
                let scriptText = await response.text();
                if (scriptText.includes('export default')) {
                    scriptText = scriptText.replace('export default', 'window.loadedGameData =');
                }
                const scriptEl = document.createElement('script');
                scriptEl.textContent = scriptText;
                document.body.appendChild(scriptEl);
                await new Promise(resolve => setTimeout(resolve, 50)); // Small delay for eval
                return window.loadedGameData || [];
            } catch (e) {
                console.error("Error manual loading games:", e);
                return [];
            }
        }

        async function initGamesLogic() {
            // Load Data
            let gamesData = await fetchGameData();
            const strongdogGames = gamesData.map(g => ({ ...g, category: 'StrongdogXP' }));
            
            let gnMathGames = [];
            try {
                const res = await fetch(GN_ZONES_URL);
                const gnMathRaw = await res.json();
                gnMathGames = gnMathRaw.map(g => ({ id: `gn-${g.id}`, name: g.name, imgSrc: g.cover.replace("{COVER_URL}", GN_COVER_URL_BASE), category: 'GN-Math', url: g.url.replace("{HTML_URL}", GN_HTML_URL_BASE) }));
            } catch (e) { console.warn("GN-Math load failed", e); }

            // Hardcoded others (simplified)
            const othersGames = [
                { id: "other-eaglercraft", name: "Eaglercraft", imgSrc: "./images/eaglercraft.png", category: "Others", url: "https://g.3kh0.net/minecraft-1.8/index.html" }, // Example external URL to avoid relative path issues in root
                { id: "other-doom", name: "DOOM", imgSrc: "./images/doom.png", category: "Others", url: "https://g.3kh0.net/doom/index.html" }
            ];

            allGames = [...strongdogGames, ...gnMathGames, ...othersGames];
            
            // Searchable Setup
            searchableGames = allGames; // Simplified flat list for now

            categories = ['StrongdogXP', 'GN-Math', 'Others'].filter(cat => allGames.some(g => g.category === cat));
            
            // Render Categories
            const categoryColors = { 'StrongdogXP': 'text-strongdog-orange', 'GN-Math': 'text-gn-math', 'Others': 'text-other-grey' };
            categorySlider.style.width = `${categories.length * 100}%`;
            categorySlider.innerHTML = categories.map(cat => `<div class="w-64 flex-shrink-0"><h2 class="text-3xl font-bold ${categoryColors[cat] || 'text-white'}"><strong>${cat}</strong></h2></div>`).join('');

            switchCategory(0);
            renderFavorites();
            setupInstructionOverlay();

            // Listeners
            prevCategoryBtn.addEventListener('click', () => switchCategory(currentCategoryIndex - 1));
            nextCategoryBtn.addEventListener('click', () => switchCategory(currentCategoryIndex + 1));
            document.getElementById('closeBtnZone').addEventListener('click', closeZoneViewer);
            searchInput.addEventListener("input", handleSearch);
        }

        function switchCategory(newIndex) {
            if (newIndex < 0 || newIndex >= categories.length) return;
            currentCategoryIndex = newIndex;
            categorySlider.style.transform = `translateX(-${currentCategoryIndex * (100 / categories.length)}%)`;
            
            // Render Grid
            const categoryName = categories[currentCategoryIndex];
            const games = allGames.filter(g => g.category === categoryName);
            gamesGridContainer.innerHTML = '';
            games.forEach(g => {
                const card = createGameCard(g);
                gamesGridContainer.appendChild(card);
            });
            
            prevCategoryBtn.disabled = currentCategoryIndex === 0;
            nextCategoryBtn.disabled = currentCategoryIndex === categories.length - 1;
        }

        function createGameCard(game) {
            // Simplified Image Res
            let imgSrc = game.imgSrc;
            if (game.category === 'StrongdogXP') {
                // Fix relative paths for root context if needed, but for now assuming remote or absolute
                // If it's relative like ./img/..., it might fail if not in logged-in/
                // We'll use the worker root if needed
                if (!imgSrc.startsWith('http')) imgSrc = `${GAMES_BASE_URL}img/${imgSrc}`;
            }

            const card = document.createElement("div");
            card.className = 'zone-item bg-card-dark rounded-2xl border border-brand-border overflow-hidden';
            card.innerHTML = `
                <div class="relative w-full cursor-pointer group">
                    <div class="aspect-w-3 aspect-h-2"><img src="${imgSrc}" alt="${game.name}" class="w-full h-full object-cover"></div>
                    <h3 class="absolute top-2 right-2 z-10 max-w-[80%] bg-black/60 backdrop-blur-md rounded-xl px-3 py-1.5 text-white truncate text-sm font-semibold shadow-lg">${game.name}</h3>
                </div>
            `;
            card.onclick = () => openZone(game);
            return card;
        }

        // --- Game Viewer ---
        async function openZone(game) {
            zoneNameEl.textContent = game.name;
            zoneFrame.src = 'about:blank';
            
            // Retry Logic
            const attemptLoad = async (retriesLeft) => {
                try {
                    // Direct src set for simplicity in this merged test
                    // For Strongdog/Complex URLs, we might need the embed path logic
                    // But for this test, we try direct URL first
                    let targetUrl = game.url;
                    
                    // Simple URL fix for Strongdog if needed
                    if (game.category === 'StrongdogXP' && !targetUrl.startsWith('http')) {
                         targetUrl = `${WORKER_ROOT}STRONGDOG/${targetUrl}`; // Simplified assumption
                    }

                    zoneFrame.src = targetUrl;
                    
                    zoneViewer.style.display = "flex";
                    zoneViewer.classList.add('active', 'animate-fade-in');
                } catch (e) {
                    if (retriesLeft > 0) setTimeout(() => attemptLoad(retriesLeft - 1), 1000);
                    else {
                        const doc = zoneFrame.contentWindow.document;
                        doc.open(); doc.write("<h1>Load Failed</h1>"); doc.close();
                        zoneViewer.style.display = "flex";
                    }
                }
            };
            attemptLoad(2);
        }

        function closeZoneViewer() {
            zoneViewer.classList.remove('active');
            setTimeout(() => {
                zoneViewer.style.display = "none";
                zoneFrame.src = 'about:blank';
            }, 300);
        }

        // Favorites (Simplified)
        function renderFavorites() {
            // Empty for this test, focusing on loading games without errors
        }

        // Search (Simplified)
        function handleSearch() {
            // ... existing logic ...
        }

        // --- Instructions ---
        function setupInstructionOverlay() {
            if (localStorage.getItem(INSTRUCTION_KEY) !== 'seen') {
                instructionOverlay.style.display = 'flex';
                // Trigger reflow
                setTimeout(() => {
                    instructionOverlay.classList.remove('opacity-0');
                    instructionOverlay.classList.add('opacity-100');
                }, 10);
                
                instructionInput.addEventListener('input', (e) => {
                    if (e.target.value.trim().toLowerCase() === 'i understand') {
                        instructionOverlay.classList.remove('opacity-100');
                        instructionOverlay.classList.add('opacity-0');
                        setTimeout(() => {
                            instructionOverlay.style.display = 'none';
                            localStorage.setItem(INSTRUCTION_KEY, 'seen');
                        }, 300);
                    }
                });
            }
        }

        // Init
        checkAutoLogin();

    </script>
</body>
</html>
