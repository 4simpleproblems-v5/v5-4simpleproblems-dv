<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - WEATHER</title>
    <meta name="description" content="Smart weather dashboard for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- 4SP BASE STYLING --- */
        :root {
            --bg-page: #040404;
            --bg-container: #000000;
            --border-color: #333;
            --text-primary: #c0c0c0;
            --color-indigo: #4f46e5;
            --menu-bg: #000000;
            --menu-border: #333;
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: var(--bg-page);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong {
            font-weight: 400 !important;
        }

        /* --- UI COMPONENTS --- */
        .btn-toolbar-style {
            background: var(--menu-bg, #000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .provider-select-wrapper {
            position: relative;
            display: inline-block;
            min-width: 180px; /* Minimum width */
        }
        
        .provider-select {
            appearance: none;
            background: #0d0d0d;
            border: 1px solid #333;
            color: #fff;
            padding: 0.6rem 2.5rem 0.6rem 1rem;
            border-radius: 0.75rem;
            font-family: 'Geist', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            width: auto; /* Allow width to change based on content */
            min-width: 100%;
            transition: border-color 0.2s;
        }
        
        .provider-select:hover {
            border-color: #6366f1;
        }
        
        .provider-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .select-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6b7280;
            font-size: 0.75rem;
        }

        /* --- LAYOUT UTILS --- */
        #page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            border-bottom: 1px solid #1a1a1a;
            background-color: var(--bg-page);
        }
        @media(min-width: 768px) {
            header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        /* --- WEATHER CARDS --- */
        .weather-card {
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 1.5rem;
            padding: 1.5rem;
            transition: border-color 0.2s;
        }
        .weather-card:hover {
            border-color: #333;
        }

        /* Hero Section */
        .current-temp {
            font-family: 'Roboto', sans-serif;
            font-size: 4rem;
            font-weight: 300;
            color: #fff;
            line-height: 1;
        }
        .current-icon {
            font-size: 3rem;
            color: var(--color-indigo);
        }

        /* Hourly Scroll */
        .scroll-mask-container {
            position: relative;
            width: 100%;
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
        }
        
        .hourly-container {
            display: flex;
            overflow-x: auto;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            margin-top: 0.5rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .hourly-container::-webkit-scrollbar { display: none; }

        .hourly-item {
            min-width: 80px;
            background: #111;
            border: 1px solid #222;
            border-radius: 1rem;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hourly-item:hover {
            background: #1a1a1a;
            border-color: #333;
            transform: translateY(-2px);
        }
        .hourly-time { font-size: 0.8rem; color: #707070; }
        .hourly-temp { font-weight: 500; color: #fff; }

        /* Daily List */
        .daily-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid #1a1a1a;
            transition: background 0.2s;
            border-radius: 1rem;
        }
        .daily-row:hover { background-color: #111; }
        .daily-row:last-child { border-bottom: none; }
        .daily-day { width: 100px; font-weight: 500; color: #fff; }
        .daily-icon { width: 40px; text-align: center; color: #9ca3af; }
        .daily-temps { display: flex; gap: 1rem; width: 100px; justify-content: flex-end; }
        .temp-high { color: #fff; }
        .temp-low { color: #707070; }

        /* --- LOADING OVERLAY --- */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #040404;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            transition: opacity 0.5s;
        }
        
        /* --- MODAL (HOURLY) --- */
        #hourly-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        #hourly-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 2rem;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        #hourly-modal-overlay.active .modal-content { transform: scale(1); }
        
        .modal-header-text { font-size: 1.25rem; color: #fff; font-weight: 400; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #1a1a1a; padding-bottom: 0.5rem; }
        .detail-label { color: #707070; font-size: 0.9rem; }
        .detail-value { color: #fff; font-weight: 500; }
        
        /* Option Styling (Limited support) */
        option { background-color: #000; color: #fff; padding: 10px; }

    /* INJECTED STYLES (Animations) */
    :root { --bg-page: #040404; --bg-container: #000000; --border-color: #333; --text-primary: #c0c0c0; --text-light-grey: #d1d5db; --accent-color: #6366f1; }
    @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-5deg); } 50% { transform: translateX(5px) rotate(5deg); } 75% { transform: translateX(-5px) rotate(-5deg); } 100% { transform: translateX(0); } }
    .shake-anim { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    body:not(.no-animations) .btn-toolbar-style, body:not(.no-animations) .hourly-item, body:not(.no-animations) .daily-row { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    body:not(.no-animations) .btn-toolbar-style:active { transform: scale(0.96); }
    </style>
    
</head>
<body class="min-h-screen">

    <div id="loading-overlay">
        <i class="fa-solid fa-spinner fa-spin fa-2x text-white mb-4"></i>
        <div id="loading-text" class="text-sm tracking-widest uppercase text-gray-500">Locating...</div>
    </div>
    
    <div id="hourly-modal-overlay">
        <div class="modal-content">
            <div class="flex items-center gap-4">
                <div id="modal-icon-container" class="text-4xl text-[#6366f1]"></div>
                <div>
                    <div id="modal-time" class="modal-header-text"></div>
                    <div id="modal-desc" class="text-gray-400 text-sm"></div>
                </div>
            </div>
            <div id="modal-details-list" class="flex flex-col gap-3 pt-2">
                </div>
            <button class="btn-toolbar-style w-full mt-4 justify-center" onclick="closeHourlyModal()">Close</button>
        </div>
    </div>

    <header>
        <div>
            <h1 class="text-2xl font-bold text-white tracking-wide">4SP WEATHER</h1>
            <div id="location-display" class="text-xs text-[#707070] flex items-center gap-2 mt-1">
               <span id="loc-name">Detecting...</span>
            </div>
        </div>
        
        <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
            <button id="btn-geo" class="btn-toolbar-style w-full md:w-auto">
                <i class="fa-solid fa-location-crosshairs text-[#6366f1]"></i>
                <span>Use Current Location</span>
            </button>

            <div class="provider-select-wrapper w-full md:w-auto">
                <select id="provider-select" class="provider-select">
                    <option value="nws">üá∫üá∏ NWS (Official)</option>
                    <option value="open-meteo">üåç Open-Meteo (Global)</option>
                </select>
                <i class="fa-solid fa-chevron-down select-icon"></i>
            </div>
        </div>
    </header>

    <main id="main-content" class="flex-1 p-4 md:p-8 max-w-5xl mx-auto w-full flex flex-col gap-6 opacity-0 transition-opacity duration-500">
        
        <div class="weather-card flex flex-col md:flex-row items-center justify-between gap-8">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <div class="text-xs text-[#4f46e5] uppercase tracking-widest font-bold mb-2">Current Conditions</div>
                <div class="flex items-center gap-6">
                    <div id="curr-icon" class="current-icon"><i class="fa-solid fa-spinner fa-spin"></i></div>
                    <div>
                        <div id="curr-temp" class="current-temp">--¬∞</div>
                        <div id="curr-desc" class="text-xl text-gray-400">Loading data...</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-x-12 gap-y-6 text-right w-full md:w-auto">
                <div class="flex flex-col">
                    <div class="text-[10px] text-[#707070] uppercase tracking-wider mb-1">High</div>
                    <div id="curr-high" class="text-2xl text-white font-medium">--¬∞</div>
                </div>
                <div class="flex flex-col">
                    <div class="text-[10px] text-[#707070] uppercase tracking-wider mb-1">Low</div>
                    <div id="curr-low" class="text-2xl text-gray-400 font-medium">--¬∞</div>
                </div>
                <div class="flex flex-col">
                    <div class="text-[10px] text-[#707070] uppercase tracking-wider mb-1">Wind</div>
                    <div id="curr-wind" class="text-lg text-gray-300">--</div>
                </div>
                <div class="flex flex-col">
                    <div class="text-[10px] text-[#707070] uppercase tracking-wider mb-1">Humidity</div>
                    <div id="curr-hum" class="text-lg text-gray-300">--%</div>
                </div>
            </div>
        </div>

        <div class="weather-card overflow-hidden">
            <div class="text-xs text-gray-500 uppercase tracking-widest mb-2 px-2">Hourly Forecast</div>
            <div class="scroll-mask-container">
                <div id="hourly-container" class="hourly-container">
                    </div>
            </div>
        </div>

        <div class="weather-card">
            <div class="text-xs text-gray-500 uppercase tracking-widest mb-4">7-Day Forecast</div>
            <div id="daily-container">
                </div>
        </div>

    </main>

    <script>
        // --- CONFIG & STATE ---
        const STATE = {
            lat: null,
            lon: null,
            city: null,
            region: null,
            provider: 'nws', 
            data: null,
            locationAllowed: false 
        };

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const mainContent = document.getElementById('main-content');
        const locNameEl = document.getElementById('loc-name');
        const providerSelect = document.getElementById('provider-select');
        const btnGeo = document.getElementById('btn-geo');

        // Current Els
        const currTempEl = document.getElementById('curr-temp');
        const currDescEl = document.getElementById('curr-desc');
        const currIconEl = document.getElementById('curr-icon');
        const currHighEl = document.getElementById('curr-high');
        const currLowEl = document.getElementById('curr-low');
        const currWindEl = document.getElementById('curr-wind');
        const currHumEl = document.getElementById('curr-hum');

        // Containers
        const hourlyContainer = document.getElementById('hourly-container');
        const dailyContainer = document.getElementById('daily-container');
        
        // Modal
        const modalOverlay = document.getElementById('hourly-modal-overlay');
        const modalTime = document.getElementById('modal-time');
        const modalDesc = document.getElementById('modal-desc');
        const modalIconCont = document.getElementById('modal-icon-container');
        const modalList = document.getElementById('modal-details-list');

        // --- ICONS MAPPING ---
        function getIconFromWMO(code, isDay = 1) {
            const day = isDay === 1;
            const map = {
                0: day ? 'fa-sun' : 'fa-moon', 
                1: day ? 'fa-cloud-sun' : 'fa-cloud-moon',
                2: day ? 'fa-cloud-sun' : 'fa-cloud-moon', 
                3: 'fa-cloud', 
                45: 'fa-smog', 48: 'fa-smog',
                51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-showers-heavy',
                61: 'fa-cloud-rain', 63: 'fa-cloud-rain', 65: 'fa-cloud-showers-heavy',
                71: 'fa-snowflake', 73: 'fa-snowflake', 75: 'fa-snowflake', 77: 'fa-snowflake',
                80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy',
                95: 'fa-cloud-bolt', 96: 'fa-cloud-bolt', 99: 'fa-cloud-bolt'
            };
            return `fa-solid ${map[code] || 'fa-cloud'}`;
        }

        function getIconFromNWS(shortForecast, isDay) {
            const lower = shortForecast.toLowerCase();
            const prefix = 'fa-solid'; 
            
            if (lower.includes('thunder')) return `${prefix} fa-cloud-bolt`;
            if (lower.includes('snow') || lower.includes('flurries')) return `${prefix} fa-snowflake`;
            if (lower.includes('rain') || lower.includes('shower')) return `${prefix} fa-cloud-showers-heavy`;
            if (lower.includes('drizzle')) return `${prefix} fa-cloud-rain`;
            if (lower.includes('fog') || lower.includes('haze')) return `${prefix} fa-smog`;
            if (lower.includes('wind')) return `${prefix} fa-wind`;
            
            if (lower.includes('partly cloudy') || lower.includes('partly sunny')) return isDay ? `${prefix} fa-cloud-sun` : `${prefix} fa-cloud-moon`;
            if (lower.includes('mostly cloudy') || lower.includes('overcast')) return `${prefix} fa-cloud`;
            if (lower.includes('cloud')) return `${prefix} fa-cloud`;
            
            if (lower.includes('sunny') || lower.includes('clear')) return isDay ? `${prefix} fa-sun` : `${prefix} fa-moon`;
            
            return `${prefix} fa-cloud`;
        }

        // --- LOCATION & SEARCH SERVICES ---

        async function init() {
            triggerAutoLocation();
        }

        async function triggerAutoLocation() {
            loadingText.innerText = "Locating...";
            loadingOverlay.style.opacity = '1';
            loadingOverlay.style.pointerEvents = 'auto';
            
            try {
                const pos = await getBrowserLocation();
                STATE.lat = pos.coords.latitude;
                STATE.lon = pos.coords.longitude;
                STATE.locationAllowed = true;
                loadingText.innerText = "Coordinates Found...";
                loadWeather();
            } catch (e) {
                console.warn("Browser geolocation failed:", e);
                STATE.locationAllowed = false;
                loadingText.innerText = "Using IP Fallback...";
                try {
                    await getIPLocation();
                    loadWeather();
                } catch (err) {
                    loadingText.innerText = "Location Failed.";
                    alert("Could not determine location. Check browser permissions.");
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.style.pointerEvents = 'none';
                }
            }
        }

        function getBrowserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) reject("Not supported");
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true, timeout: 5000, maximumAge: 0
                });
            });
        }

        async function getIPLocation() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error("IP API failed");
                const data = await res.json();
                STATE.lat = data.latitude;
                STATE.lon = data.longitude;
                STATE.city = data.city;
                STATE.region = data.region_code;
                updateLocationDisplay();
            } catch (e) {
                console.warn("IP location fetch failed:", e);
                // Fallback to defaults (NY)
                STATE.lat = 40.7128;
                STATE.lon = -74.0060;
                STATE.city = "New York";
                STATE.region = "NY";
                updateLocationDisplay();
            }
        }
        
        btnGeo.addEventListener('click', () => {
            triggerAutoLocation();
        });

        // --- WEATHER FETCHING LOGIC ---

        async function loadWeather() {
            loadingOverlay.style.opacity = '1';
            loadingOverlay.style.pointerEvents = 'auto';
            
            try {
                if (STATE.provider === 'nws') {
                    await fetchNWS();
                } else {
                    await fetchOpenMeteo();
                }
                render();
                
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.style.pointerEvents = 'none';
                    mainContent.style.opacity = '1';
                }, 500);

            } catch (e) {
                console.error("Weather Load Error:", e);
                if (STATE.provider === 'nws') {
                    console.log("NWS failed (likely outside US). Switching to Open-Meteo...");
                    STATE.provider = 'open-meteo';
                    providerSelect.value = 'open-meteo';
                    loadWeather(); 
                } else {
                    loadingText.innerText = "Error Loading Weather";
                    alert("Failed to load weather data.");
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.style.pointerEvents = 'none';
                }
            }
        }

        // --- NWS API ---
        async function fetchNWS() {
            loadingText.innerText = "Contacting National Weather Service...";
            const pointsUrl = `https://api.weather.gov/points/${STATE.lat},${STATE.lon}`;
            const pointsRes = await fetch(pointsUrl);
            
            if (pointsRes.status === 404 || pointsRes.status === 400) throw new Error("Location not supported by NWS");
            
            const pointsData = await pointsRes.json();
            const props = pointsData.properties;
            
            STATE.city = props.relativeLocation.properties.city;
            STATE.region = props.relativeLocation.properties.state;
            updateLocationDisplay();

            const forecastUrl = props.forecast;
            const hourlyUrl = props.forecastHourly;
            loadingText.innerText = "Downloading Forecasts...";
            
            const [dailyRes, hourlyRes] = await Promise.all([fetch(forecastUrl), fetch(hourlyUrl)]);
            const dailyData = await dailyRes.json();
            const hourlyData = await hourlyRes.json();

            STATE.data = processNWSData(dailyData, hourlyData);
        }

        function processNWSData(dailyRaw, hourlyRaw) {
            const current = hourlyRaw.properties.periods[0];
            const periodGroups = {};
            
            dailyRaw.properties.periods.forEach(p => {
                const date = p.startTime.split('T')[0];
                if (!periodGroups[date]) {
                    periodGroups[date] = { temps: [], icons: [], isDay: [] };
                }
                periodGroups[date].temps.push(p.temperature);
                periodGroups[date].icons.push(p.shortForecast);
                periodGroups[date].isDay.push(p.isDaytime);
            });

            const dailyList = Object.keys(periodGroups).sort().slice(0, 7).map(date => {
                const group = periodGroups[date];
                const high = Math.max(...group.temps);
                const low = Math.min(...group.temps);
                let iconDesc = group.icons[0];
                const dayIdx = group.isDay.indexOf(true);
                if (dayIdx !== -1) iconDesc = group.icons[dayIdx];

                return {
                    dateName: new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }),
                    high: high,
                    low: low,
                    iconClass: getIconFromNWS(iconDesc, true)
                };
            });

            return {
                current: {
                    temp: current.temperature,
                    desc: current.shortForecast,
                    high: dailyList[0]?.high || current.temperature,
                    low: dailyList[0]?.low || current.temperature - 10,
                    wind: `${current.windSpeed} ${current.windDirection}`,
                    humidity: current.relativeHumidity.value,
                    iconClass: getIconFromNWS(current.shortForecast, current.isDaytime)
                },
                hourly: hourlyRaw.properties.periods.slice(0, 24).map(h => ({
                    time: new Date(h.startTime).getHours(),
                    fullTime: h.startTime,
                    temp: h.temperature,
                    desc: h.shortForecast,
                    iconClass: getIconFromNWS(h.shortForecast, h.isDaytime),
                    details: {
                        "Wind": `${h.windSpeed} ${h.windDirection}`,
                        "Precipitation": `${h.probabilityOfPrecipitation.value || 0}%`,
                        "Humidity": `${h.relativeHumidity.value}%`,
                    }
                })),
                daily: dailyList
            };
        }

        // --- OPEN-METEO API ---
        async function fetchOpenMeteo() {
            loadingText.innerText = "Contacting Open-Meteo...";
            if (!STATE.city) updateLocationDisplay(); 

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${STATE.lat}&longitude=${STATE.lon}&current=temperature_2m,relative_humidity_2m,is_day,weather_code,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code,is_day,precipitation_probability,wind_speed_10m,wind_direction_10m,uv_index,cloud_cover&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto`;
            const res = await fetch(url);
            const data = await res.json();

            STATE.data = processOpenMeteoData(data);
        }

        function processOpenMeteoData(data) {
            const curr = data.current;
            const daily = data.daily;
            const hourly = data.hourly;
            const now = new Date();
            const currentHour = now.getHours();

            const hourlyList = [];
            for(let i = currentHour; i < currentHour + 24; i++) {
                if (hourly.time[i]) {
                    const d = new Date(hourly.time[i]);
                    const code = hourly.weather_code[i];
                    hourlyList.push({
                        time: d.getHours(),
                        fullTime: hourly.time[i],
                        temp: Math.round(hourly.temperature_2m[i]),
                        desc: getWMODescription(code),
                        iconClass: getIconFromWMO(code, hourly.is_day[i]),
                        details: {
                            "Wind": `${Math.round(hourly.wind_speed_10m[i])} mph`,
                            "Precipitation": `${hourly.precipitation_probability[i]}%`,
                            "UV Index": hourly.uv_index[i],
                            "Cloud Cover": `${hourly.cloud_cover[i]}%`
                        }
                    });
                }
            }

            const dailyList = [];
            for(let i=0; i<daily.time.length; i++) {
                const dayName = new Date(daily.time[i] + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' });
                dailyList.push({
                    dateName: dayName,
                    high: Math.round(daily.temperature_2m_max[i]),
                    low: Math.round(daily.temperature_2m_min[i]),
                    iconClass: getIconFromWMO(daily.weather_code[i], 1)
                });
            }

            return {
                current: {
                    temp: Math.round(curr.temperature_2m),
                    desc: getWMODescription(curr.weather_code),
                    high: Math.round(daily.temperature_2m_max[0]),
                    low: Math.round(daily.temperature_2m_min[0]),
                    wind: `${Math.round(curr.wind_speed_10m)} mph`,
                    humidity: curr.relative_humidity_2m,
                    iconClass: getIconFromWMO(curr.weather_code, curr.is_day)
                },
                hourly: hourlyList,
                daily: dailyList
            };
        }

        function getWMODescription(code) {
            const codes = {
                0: 'Clear Sky', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Rime Fog', 51: 'Light Drizzle', 53: 'Moderate Drizzle', 55: 'Dense Drizzle',
                61: 'Slight Rain', 63: 'Moderate Rain', 65: 'Heavy Rain', 71: 'Slight Snow', 73: 'Moderate Snow', 75: 'Heavy Snow',
                80: 'Slight Showers', 81: 'Moderate Showers', 82: 'Violent Showers', 95: 'Thunderstorm', 96: 'Hailstorm'
            };
            return codes[code] || 'Unknown';
        }

        // --- RENDER ---
        function render() {
            if (!STATE.data) return;
            const d = STATE.data;
            
            currTempEl.innerText = `${d.current.temp}¬∞`;
            currDescEl.innerText = d.current.desc;
            currHighEl.innerText = `${d.current.high}¬∞`;
            currLowEl.innerText = `${d.current.low}¬∞`;
            currWindEl.innerText = d.current.wind;
            currHumEl.innerText = `${d.current.humidity}%`;
            currIconEl.innerHTML = `<i class="${d.current.iconClass}"></i>`;

            hourlyContainer.innerHTML = d.hourly.map((h, index) => {
                const ampm = h.time >= 12 ? 'PM' : 'AM';
                const h12 = h.time % 12 || 12;
                return `
                    <div class="hourly-item" onclick="openHourlyModal(${index})">
                        <div class="hourly-time">${h12} ${ampm}</div>
                        <div class="text-2xl text-[#4f46e5]"><i class="${h.iconClass}"></i></div>
                        <div class="hourly-temp">${h.temp}¬∞</div>
                    </div>
                `;
            }).join('');

            dailyContainer.innerHTML = d.daily.map(day => `
                <div class="daily-row">
                    <div class="daily-day">${day.dateName}</div>
                    <div class="daily-icon text-xl"><i class="${day.iconClass}"></i></div>
                    <div class="daily-temps">
                        <span class="temp-high font-medium">${day.high}¬∞</span>
                        <span class="temp-low text-sm">${day.low}¬∞</span>
                    </div>
                </div>
            `).join('');
        }
        
        // --- MODAL LOGIC ---
        window.openHourlyModal = (index) => {
            const item = STATE.data.hourly[index];
            if(!item) return;
            
            const dateObj = new Date(item.fullTime);
            const timeStr = dateObj.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const dateStr = dateObj.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });

            modalTime.innerText = `${timeStr} - ${dateStr}`;
            modalDesc.innerText = item.desc;
            modalIconCont.innerHTML = `<i class="${item.iconClass}"></i>`;
            
            modalList.innerHTML = '';
            for (const [key, val] of Object.entries(item.details)) {
                const row = document.createElement('div');
                row.className = 'detail-row';
                row.innerHTML = `<span class="detail-label">${key}</span><span class="detail-value">${val}</span>`;
                modalList.appendChild(row);
            }
            
            modalOverlay.classList.add('active');
        };

        window.closeHourlyModal = () => {
            modalOverlay.classList.remove('active');
        };
        
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeHourlyModal();
        });

        function updateLocationDisplay() {
            if (STATE.city && STATE.region) {
                locNameEl.innerText = `${STATE.city}, ${STATE.region}`;
            } else if (STATE.lat) {
                locNameEl.innerText = `${STATE.lat.toFixed(2)}, ${STATE.lon.toFixed(2)}`;
            }
        }

        // --- EVENTS ---
        providerSelect.addEventListener('change', (e) => {
            STATE.provider = e.target.value;
            loadWeather();
        });

        // Start
        window.addEventListener('load', init);

    </script>

    <div id="notification-container"></div>
    <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = false; let areAnimationsEnabled = true;
    function playClickSound() {
        if (isMuted) return; if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.015);
        osc.start(); osc.stop(audioCtx.currentTime + 0.015);
    }
    function playTypeSound() {
        if (isMuted) return; if (audioCtx.state === 'suspended') audioCtx.resume();
        const bufferSize = audioCtx.sampleRate * 0.02; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
        const noiseFilter = audioCtx.createBiquadFilter(); noiseFilter.type = 'bandpass'; noiseFilter.frequency.value = 3000 + (Math.random() * 1000); noiseFilter.Q.value = 1;
        const noiseGain = audioCtx.createGain(); noiseGain.gain.setValueAtTime(0.04, audioCtx.currentTime); noiseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.01);
        noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(audioCtx.destination);
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(150 + (Math.random() * 50), audioCtx.currentTime);
        gain.gain.setValueAtTime(0.03, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.02);
        osc.connect(gain); gain.connect(audioCtx.destination);
        noise.start(); osc.start(); noise.stop(audioCtx.currentTime + 0.02); osc.stop(audioCtx.currentTime + 0.02);
    }
    const notificationContainer = document.getElementById('notification-container');
    function showNotification(message, iconClass = 'fa-solid fa-info-circle', type = 'info') {
        if (!notificationContainer) return;
        while (notificationContainer.children.length >= 3) notificationContainer.removeChild(notificationContainer.firstChild);
        const toast = document.createElement('div'); toast.className = 'notification-toast';
        toast.innerHTML = `<i class="${iconClass} notification-icon ${type}"></i><span>${message}</span>`;
        notificationContainer.appendChild(toast);
        requestAnimationFrame(() => { toast.classList.add('show'); playClickSound(); });
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (toast.parentElement) toast.remove(); }, 300); }, 3000);
    }
    document.addEventListener('click', (e) => { const target = e.target.closest('button, .nav-tab, .zone-item, .btn-card-action, a, .icon-btn'); if (target) playClickSound(); });
    document.addEventListener('keydown', (e) => { const target = e.target.closest('input, textarea'); if (target && !e.repeat) playTypeSound(); });
    document.addEventListener('copy', () => { if (window.getSelection().toString().length > 0) showNotification('Copied to clipboard', 'fa-solid fa-copy', 'success'); });
    document.addEventListener('paste', (e) => { if (e.target.closest('input, textarea')) showNotification('Pasted from clipboard', 'fa-solid fa-paste', 'info'); });
    </script>

</body>
</html>